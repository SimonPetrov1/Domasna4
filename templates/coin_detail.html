{% extends "base.html" %}
{% block content %}

<div class="coin-header-card mt-3">
  <div class="d-flex justify-content-between align-items-center">
    <div>
      <div class="fw-semibold" style="font-size:18px;">
        {{ symbol }} <span class="text-muted" style="font-size:14px;">/ USD</span>
      </div>
      <div class="d-flex align-items-baseline mt-2">
        <div class="price-main" style="font-size:28px;">
          ${{ "%.2f"|format(last.close) }}
        </div>
        <div class="price-change ms-2" style="font-size:13px;">
          +1.02%
        </div>
      </div>
    </div>

    <div class="d-flex gap-3 small">
      <div class="text-end">
        <div class="text-muted">1h</div>
        <div class="{% if change_1h >= 0 %}text-success{% else %}text-danger{% endif %}">
          {{ "%.2f"|format(change_1h) }}%
        </div>
      </div>
      <div class="text-end">
        <div class="text-muted">7d</div>
        <div class="{% if change_7d >= 0 %}text-success{% else %}text-danger{% endif %}">
          {{ "%.2f"|format(change_7d) }}%
        </div>
      </div>
      <div class="text-end">
        <div class="text-muted">30d</div>
        <div class="{% if change_30d >= 0 %}text-success{% else %}text-danger{% endif %}">
          {{ "%.2f"|format(change_30d) }}%
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row g-3 mt-1">
  <div class="col-lg-8">
    <div class="card p-3 mb-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div class="section-title mb-0">Price chart</div>
        <div class="btn-group btn-group-sm" role="group" id="range-buttons">
          <button type="button" class="btn btn-outline-secondary active" data-range="24h">24H</button>
          <button type="button" class="btn btn-outline-secondary" data-range="7d">7D</button>
          <button type="button" class="btn btn-outline-secondary" data-range="1m">1M</button>
          <button type="button" class="btn btn-outline-secondary" data-range="3m">3M</button>
          <button type="button" class="btn btn-outline-secondary" data-range="1y">1Y</button>
          <button type="button" class="btn btn-outline-secondary" data-range="all">ALL</button>
        </div>
      </div>
      <div id="price-chart" style="height:260px;"></div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card p-3 mb-3">
      <div class="section-title">Market statistics</div>
      <div class="d-flex justify-content-between border-bottom py-1">
        <span class="small text-muted">Open</span>
        <span>${{ "%.2f"|format(last.open) }}</span>
      </div>
      <div class="d-flex justify-content-between border-bottom py-1">
        <span class="small text-muted">High</span>
        <span>${{ "%.2f"|format(last.high) }}</span>
      </div>
      <div class="d-flex justify-content-between border-bottom py-1">
        <span class="small text-muted">Low</span>
        <span>${{ "%.2f"|format(last.low) }}</span>
      </div>
      <div class="d-flex justify-content-between border-bottom py-1">
        <span class="small text-muted">Close</span>
        <span>${{ "%.2f"|format(last.close) }}</span>
      </div>
      <div class="d-flex justify-content-between border-bottom py-1">
        <span class="small text-muted">Volume</span>
        <span>${{ "%.2f"|format(last.volume) }}</span>
      </div>
      <div class="d-flex justify-content-between py-1">
        <span class="small text-muted">Last price</span>
        <span>${{ "%.2f"|format(last.close) }}</span>
      </div>
    </div>
  </div>
</div>

{% set max_close = (rows | map(attribute='close') | max) %}
{% set min_close = (rows | map(attribute='close') | min) %}

<div class="row g-3 mt-1">
  <div class="col-lg-8">
    <div class="card p-3" style="border-radius:20px;">
      <div class="mb-2 fw-semibold">Market overview</div>
      <div class="row g-3">
        <div class="col-md-6">
          <div class="stat-card" style="background:#ecfdf5; padding:12px;">
            <div class="stat-title">Trading volume</div>
            <div class="stat-value">${{ trading_vol_fmt }}</div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="stat-card" style="background:#ffe4e6; padding:12px;">
            <div class="stat-title">Market cap</div>
            <div class="stat-value">
              ${{ market_cap_fmt }}
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="stat-card" style="background:#eef2ff; padding:12px;">
            <div class="stat-title">Range</div>
            <div class="stat-value">
              {{ range_low_fmt }} – {{ range_high_fmt }}
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="stat-card" style="background:#fdf2ff; padding:12px;">
            <div class="stat-title">Close</div>
            <div class="stat-value">${{ close_fmt }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card p-3 mb-2" style="background:#ecfdf5;">
      <div class="section-title mb-1">All‑time high</div>
      <div class="fw-bold">${{ "%.2f"|format(max_close) }}</div>
      <div class="small text-muted">Highest close price in history</div>
    </div>

    <div class="card p-3" style="background:#fef2f2;">
      <div class="section-title mb-1">All‑time low</div>
      <div class="fw-bold">${{ "%.2f"|format(min_close) }}</div>
      <div class="small text-muted">Lowest close price in history</div>
    </div>
  </div>
</div>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
  const fullData = {{ chart_data|safe }};

  function filterRange(range) {
    const dates = fullData.dates;
    const prices = fullData.prices;
    const n = dates.length;
    if (n === 0) return {x: [], y: []};

    const lastDate = new Date(dates[n - 1]);
    let fromDate = new Date(dates[0]); // ALL по default

    if (range === '24h') {
      fromDate = new Date(lastDate);
      fromDate.setDate(fromDate.getDate() - 1);
    } else if (range === '7d') {
      fromDate = new Date(lastDate);
      fromDate.setDate(fromDate.getDate() - 7);
    } else if (range === '1m') {
      fromDate = new Date(lastDate);
      fromDate.setMonth(fromDate.getMonth() - 1);
    } else if (range === '3m') {
      fromDate = new Date(lastDate);
      fromDate.setMonth(fromDate.getMonth() - 3);
    } else if (range === '1y') {
      fromDate = new Date(lastDate);
      fromDate.setFullYear(fromDate.getFullYear() - 1);
    } else if (range === 'all') {
      return {x: dates, y: prices};
    }

    const x = [];
    const y = [];
    for (let i = 0; i < n; i++) {
      const d = new Date(dates[i]);
      if (d >= fromDate && d <= lastDate) {
        x.push(dates[i]);
        y.push(prices[i]);
      }
    }
    return {x, y};
  }

  function draw(range) {
    const d = filterRange(range);
    const trace = {
      x: d.x,
      y: d.y,
      type: 'scatter',
      mode: 'lines',
      line: {color: '#00b894'}
    };
    Plotly.newPlot('price-chart', [trace], {
      margin: {t: 10, r: 10, l: 40, b: 40}
    });
  }

  // иницијално ALL
  draw('all');

  document.getElementById('range-buttons').addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-range]');
    if (!btn) return;
    document.querySelectorAll('#range-buttons button').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    draw(btn.dataset.range);
  });
</script>

{% endblock %}
